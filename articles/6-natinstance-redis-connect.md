---
title: "NATã‚¤ãƒ³ã‚¹ã‚¿ãƒ³ã‚¹ã‹ã‚‰Redisã¸ã®æ¥ç¶šæ‰‹é †ã¾ã¨ã‚"
emoji: "â˜ï¸"
type: "tech" # tech: æŠ€è¡“è¨˜äº‹ / idea: ã‚¢ã‚¤ãƒ‡ã‚¢
topics: ["EC2", "NATã‚¤ãƒ³ã‚¹ã‚¿ãƒ³ã‚¹", "Redis"]
published: true
---

æ¥­å‹™ã«ã¦ã€ã‚¢ãƒ—ãƒªåˆ¶ä½œãƒãƒ¼ãƒ ã‚ˆã‚Šä»¥ä¸‹ä¾é ¼ãŒã‚ã‚Šã¾ã—ãŸã€‚

:::message
æ¤œè¨¼ç”¨ã‚¢ãƒ—ãƒªã‚’Redisã«æ¥ç¶šã—ã¦ç–é€šè©¦é¨“ã‚’ã—ãŸã„ã®ã§å¯¾å¿œã—ã¦ã»ã—ã„
:::

ç§ãŒæ‰€å±ã—ã¦ã„ã‚‹ã‚¤ãƒ³ãƒ•ãƒ©ãƒãƒ¼ãƒ ã§å¯¾å¿œã™ã‚‹å†…å®¹ã«ã¤ã„ã¦ã€ä»¥ä¸‹ã¨èªè­˜ã—ã¾ã—ãŸã€‚

- NATã‚¤ãƒ³ã‚¹ã‚¿ãƒ³ã‚¹ä½œæˆ
- ãƒ­ãƒ¼ã‚«ãƒ«ç’°å¢ƒã‹ã‚‰NATã‚¤ãƒ³ã‚¹ã‚¿ãƒ³ã‚¹ã‚’çµŒç”±ã•ã›ã€Redisã‚¯ãƒ©ã‚¹ã‚¿ãƒ¼ã¸æ¥ç¶š

:::message alert

- Redisã®ä¸­èº«ã«ã¤ã„ã¦ã¯ã‚¤ãƒ³ãƒ•ãƒ©å´ã§ã¯ä½•ã‚‚è¨­å®šã—ãªã„(ã‚ãã¾ã§ãƒ­ãƒ¼ã‚«ãƒ«ã‹ã‚‰ç–é€šå‡ºæ¥ãŸã‚‰OKãƒ¬ãƒ™ãƒ«)
- IPã‚¢ãƒ‰ãƒ¬ã‚¹ã®å¤‰æ›´ã™ã‚‹ã¨ä¸éƒ½åˆã ã¨ã®ã“ã¨ã§ã€ElasticIPã§å›ºå®šã™ã‚‹
  :::

## ğŸ“ å‰ææ¡ä»¶

- Redisã‚µãƒ¼ãƒãƒ¼ã®ãƒ—ãƒ©ã‚¤ãƒ™ãƒ¼ãƒˆIPï¼š`192.168.64.228`
- Redisã‚µãƒ¼ãƒãƒ¼ã®è¨­å®šï¼ˆ`redis.conf`ï¼‰ï¼š

  ```conf
  bind 0.0.0.0
  protected-mode no
  ```

- NATã‚¤ãƒ³ã‚¹ã‚¿ãƒ³ã‚¹ã« redis-cliï¼ˆv8.0.2ï¼‰ãŒã‚¤ãƒ³ã‚¹ãƒˆãƒ¼ãƒ«æ¸ˆã¿

## ğŸ‘· Redisã‚µãƒ¼ãƒãƒ¼ã®IPã‚¢ãƒ‰ãƒ¬ã‚¹ç¢ºèªæ‰‹é †

1. Redisã‚µãƒ¼ãƒãƒ¼ãŒç¨¼åƒã—ã¦ã„ã‚‹EC2ã«ãƒ­ã‚°ã‚¤ãƒ³
2. ä»¥ä¸‹ã®ã‚³ãƒãƒ³ãƒ‰ã§IPã‚¢ãƒ‰ãƒ¬ã‚¹ã‚’ç¢ºèªï¼š

```bash
ip addr show
# ã¾ãŸã¯
hostname -I
```

3. å‡ºåŠ›ã•ã‚ŒãŸIPã‚¢ãƒ‰ãƒ¬ã‚¹ã‚’ãƒ¡ãƒ¢ï¼ˆä¾‹ï¼š192.168.64.228ï¼‰

## âš¡ Redisã¸ã®æ¥ç¶šæ‰‹é †

```bash
# NATã‚¤ãƒ³ã‚¹ã‚¿ãƒ³ã‚¹ã«ãƒ­ã‚°ã‚¤ãƒ³
ssh -i <éµãƒ•ã‚¡ã‚¤ãƒ«.pem> ec2-user@<NATã‚¤ãƒ³ã‚¹ã‚¿ãƒ³ã‚¹ã®ãƒ‘ãƒ–ãƒªãƒƒã‚¯IP>

# redis-cli ã®ã‚ã‚‹ãƒ‡ã‚£ãƒ¬ã‚¯ãƒˆãƒªã«ç§»å‹•
cd /root/redis-stable

# Redisã«æ¥ç¶š
./src/redis-cli -h 192.168.64.228 -p 6379

# æ¥ç¶šç¢ºèª
ping
# â†’ PONG ãŒè¿”ã‚Œã°æˆåŠŸ
```

## ğŸŒ€ ãƒˆãƒ©ãƒ–ãƒ«ã‚·ãƒ¥ãƒ¼ãƒ†ã‚£ãƒ³ã‚°

| ãƒã‚§ãƒƒã‚¯é …ç›®          | å†…å®¹                                                            |
| --------------------- | --------------------------------------------------------------- |
| RedisãŒèµ·å‹•ã—ã¦ã„ã‚‹ã‹ | `ps aux`                                                        |
| bindè¨­å®š              | bind 0.0.0.0 ã«ãªã£ã¦ã„ã‚‹ã‹                                     |
| protected-mode        | no ã«ãªã£ã¦ã„ã‚‹ã‹                                               |
| ã‚»ã‚­ãƒ¥ãƒªãƒ†ã‚£ã‚°ãƒ«ãƒ¼ãƒ—  | NATã‚¤ãƒ³ã‚¹ã‚¿ãƒ³ã‚¹ â†’ Redisã‚µãƒ¼ãƒãƒ¼ã¸ã® TCP:6379 ãŒè¨±å¯ã•ã‚Œã¦ã„ã‚‹ã‹ |

## âœ æ¥ç¶šç¢ºèªã§èº“ã„ãŸãƒã‚¤ãƒ³ãƒˆã¾ã¨ã‚

æ¥ç¶šç¢ºèªã§èº“ã„ãŸãƒã‚¤ãƒ³ãƒˆã¾ã¨ã‚:

1. èª¤ã£ãŸIPã‚¢ãƒ‰ãƒ¬ã‚¹ã®æŒ‡å®š

- 192.168.16.0 ã¯ãƒãƒƒãƒˆãƒ¯ãƒ¼ã‚¯ã‚¢ãƒ‰ãƒ¬ã‚¹ã§ã‚ã‚Šã€ãƒ›ã‚¹ãƒˆã«ã¯ä½¿ç”¨ä¸å¯ã€‚
- ip addr show ã‚„ hostname -I ã§æ­£ã—ã„IPã‚’ç¢ºèªã€‚

2. Redisã®è¨­å®šãŒå¤–éƒ¨æ¥ç¶šã‚’æ‹’å¦

- bind ãŒ 127.0.0.1ã€protected-mode ãŒ yes ã ã£ãŸã€‚
- å¯¾å‡¦ï¼šbind 0.0.0.0ã€protected-mode no ã«å¤‰æ›´ â†’ Rediså†èµ·å‹•ã€‚

3. redis-server ãƒã‚¤ãƒŠãƒªãŒå­˜åœ¨ã—ãªã„

- make å®Ÿè¡Œå‰ã« redis-server ãŒæœªç”Ÿæˆã€‚
- å¯¾å‡¦ï¼šmake ã‚’å®Ÿè¡Œã—ã¦ãƒ“ãƒ«ãƒ‰ã€‚

4. Redisæœªèµ·å‹•ã§æ¥ç¶šè©¦è¡Œ

- Connection refused ã‚¨ãƒ©ãƒ¼ã€‚
- å¯¾å‡¦ï¼š./src/redis-server redis.conf ã§èµ·å‹•ã€‚

5. ã‚¯ãƒ©ã‚¹ã‚¿ãƒ¼æ§‹æˆã¨èª¤èª

- cluster nodes å®Ÿè¡Œã§ã‚¨ãƒ©ãƒ¼ã€‚
- å¯¾å‡¦ï¼šredis.conf ã® cluster-enabled ã‚’ç¢ºèª â†’ å˜ä¸€ãƒãƒ¼ãƒ‰æ§‹æˆã€‚

### EC2ã‚¤ãƒ³ã‚¹ã‚¿ãƒ³ã‚¹æ§‹æˆ

- ElasticIPã§IPå›ºå®š
- ã‚¤ãƒ³ã‚¹ã‚¿ãƒ³ã‚¹ã‚¿ã‚¤ãƒ—ï¼št2.micro
- ã‚µãƒ–ãƒãƒƒãƒˆï¼šãƒ‘ãƒ–ãƒªãƒƒã‚¯
- AMIï¼šAmazon Linux 2023
- pemã‚­ãƒ¼ç™ºè¡Œæ¸ˆã¿
- NATè¨­å®šã‚ã‚Š

### ã‚»ã‚­ãƒ¥ãƒªãƒ†ã‚£ã‚°ãƒ«ãƒ¼ãƒ—ï¼ˆSGï¼‰æ§‹æˆ

- NATã‚¤ãƒ³ã‚¹ã‚¿ãƒ³ã‚¹ â†’ Redisã‚µãƒ¼ãƒãƒ¼ã¸ã® TCP:6379 ã‚’è¨±å¯
- Redis Clusterã¯Auroraç”¨SGã‚’ä½¿ç”¨
- Redisç”¨ã‚µãƒ–ãƒãƒƒãƒˆã‚°ãƒ«ãƒ¼ãƒ—ã‚’ä½œæˆï¼ˆ2ã¤ã‚ã‚‹ãŒ1ã¤ã®ã¿ä½¿ç”¨ï¼‰

### VPCé–¢é€£æ§‹æˆ

- æ¤œè¨¼ç”¨VPCã‚’ä½¿ç”¨
- ã‚µãƒ–ãƒãƒƒãƒˆï¼š
- ãƒ‘ãƒ–ãƒªãƒƒã‚¯ï¼šNATã‚¤ãƒ³ã‚¹ã‚¿ãƒ³ã‚¹ç”¨ã€ã‚¤ãƒ³ã‚¿ãƒ¼ãƒãƒƒãƒˆã‚²ãƒ¼ãƒˆã‚¦ã‚§ã‚¤è¨­å®šæ¸ˆã¿
- ãƒ—ãƒ©ã‚¤ãƒ™ãƒ¼ãƒˆï¼š0.0.0.0/0 ã‚’ãƒ«ãƒ¼ãƒˆãƒ†ãƒ¼ãƒ–ãƒ«ã«è¨­å®š
- ãƒ«ãƒ¼ãƒˆãƒ†ãƒ¼ãƒ–ãƒ«ï¼š
- ãƒ‘ãƒ–ãƒªãƒƒã‚¯ï¼š0.0.0.0/0ï¼ˆIGWï¼‰ã€192.168.0.0/16ï¼ˆVPCï¼‰
- ãƒ—ãƒ©ã‚¤ãƒ™ãƒ¼ãƒˆï¼š0.0.0.0/0ï¼ˆNATçµŒç”±ï¼‰

## ğŸ’» NATã‚¤ãƒ³ã‚¹ã‚¿ãƒ³ã‚¹ã« redis-cli ã‚’ã‚¤ãƒ³ã‚¹ãƒˆãƒ¼ãƒ«ã™ã‚‹æ‰‹é †

### 1. åŸºæœ¬ç¢ºèª

- OSï¼šAmazon Linux 2023
- ã‚¤ãƒ³ã‚¿ãƒ¼ãƒãƒƒãƒˆã‚¢ã‚¯ã‚»ã‚¹å¯èƒ½
- ãƒ‘ãƒƒã‚±ãƒ¼ã‚¸ç®¡ç†ãƒ„ãƒ¼ãƒ«ï¼šdnf

### 2. ã‚»ã‚­ãƒ¥ãƒªãƒ†ã‚£ã‚°ãƒ«ãƒ¼ãƒ—ã¨IAMãƒ­ãƒ¼ãƒ«

- SGï¼šSSHï¼ˆ22ç•ªï¼‰ãªã©å¿…è¦ãªãƒãƒ¼ãƒˆãŒé–‹ã„ã¦ã„ã‚‹ã‹
- IAMãƒ­ãƒ¼ãƒ«ï¼šå¿…è¦ã«å¿œã˜ã¦S3ãªã©ã®ã‚¢ã‚¯ã‚»ã‚¹æ¨©ã‚’ä»˜ä¸

### 3. ãƒ“ãƒ«ãƒ‰ãƒ„ãƒ¼ãƒ«ã¨ä¾å­˜ãƒ‘ãƒƒã‚±ãƒ¼ã‚¸ã®ã‚¤ãƒ³ã‚¹ãƒˆãƒ¼ãƒ«

```bash
sudo dnf groupinstall "Development Tools" -y
sudo dnf install gcc make wget tar -y
```

### 4. Redis ã‚½ãƒ¼ã‚¹ã‚³ãƒ¼ãƒ‰ã®ãƒ€ã‚¦ãƒ³ãƒ­ãƒ¼ãƒ‰ã¨ãƒ“ãƒ«ãƒ‰

```bash
wget http://download.redis.io/redis-stable.tar.gz
tar -xvzf redis-stable.tar.gz
cd redis-stable
make
```

### 5. redis-cli ã®é…ç½®

```bash
sudo cp src/redis-cli /usr/local/bin/
```

### 6. å‹•ä½œç¢ºèª

```bash
redis-cli --version
```

## å‚è€ƒãƒªãƒ³ã‚¯

### â˜ AWSé–¢é€£

https://qiita.com/kamome_ss/items/b3e82cc6e3cbf812a233  
https://qiita.com/seikida/items/8a68ceabfd1342f636bd  
https://dev.classmethod.jp/articles/how-to-create-amazon-linux-2023-nat-instance/#%25E3%2580%25902023%25E5%25B9%25B411%25E6%259C%258813%25E6%2597%25A5-%25E8%25BF%25BD%25E8%25A8%2598%25E3%2580%2591aws%25E5%2585%25AC%25E5%25BC%258F%25E3%2583%2589%25E3%2582%25AD%25E3%2583%25A5%25E3%2583%25A1%25E3%2583%25B3%25E3%2583%2588%25E3%2581%25AE%25E6%2589%258B%25E9%25A0%2586  
https://dev.classmethod.jp/articles/nat-instance-handmaid/#3.%2520%25E3%2582%25AF%25E3%2583%25A9%25E3%2582%25A4%25E3%2582%25A2%25E3%2583%25B3%25E3%2583%2588%25E3%2582%25A4%25E3%2583%25B3%25E3%2582%25B9%25E3%2582%25BF%25E3%2583%25B3%25E3%2582%25B9%25E3%2581%25AE%25E3%2582%25B5%25E3%2583%2596%25E3%2583%258D%25E3%2583%2583%25E3%2583%2588%25E3%2583%25AB%25E3%2583%25BC%25E3%2583%2588%25E3%2583%2586%25E3%2583%25BC%25E3%2583%2596%25E3%2583%25AB%25E3%2581%25AE%25E5%25A4%2589%25E6%259B%25B4

### ğŸ”’ ãƒãƒƒãƒˆãƒ¯ãƒ¼ã‚¯ãƒ»ãƒ•ã‚¡ã‚¤ã‚¢ã‚¦ã‚©ãƒ¼ãƒ«è¨­å®šï¼ˆLinuxï¼‰

https://atmarkit.itmedia.co.jp/ait/articles/1709/22/news019.html  
https://docs.redhat.com/ja/documentation/red_hat_enterprise_linux/9/html/configuring_firewalls_and_packet_filters/configuring-nat-using-nftables_getting-started-with-nftables  
https://docs.redhat.com/en/documentation/red_hat_enterprise_linux/9/html/configuring_firewalls_and_packet_filters/getting-started-with-nftables_firewall-packet-filters
