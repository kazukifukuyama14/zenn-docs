---
title: "React × Rails アプリケーション（Docker コンテナ化）"
emoji: "🐳"
type: "tech" # tech: 技術記事 / idea: アイデア
topics: ["Docker", "Dockerfile", "docker-compose"]
published: true
---

## 📝 はじめに

[Dockerの基本的なコマンドについての記事](https://zenn.dev/wan0ri/articles/ee3a7dff1b368e)で基礎を学びましたが、一からDockerイメージをPullして起動させるのは大変で管理も煩雑になります。  
そこで、Docker Composeを利用してDockerイメージのビルドと複数コンテナの管理を簡単にする手順を解説します。

## 🎤 解説

### docker composeとは？

[公式ドキュメント](https://docs.docker.jp/compose/index.html)によると：

> Compose とは、複数のコンテナを定義し実行する Docker アプリケーションのためのツールです。
> Compose は YAML ファイルを使い、アプリケーションのサービスを設定します。コマンドを１つ実行するだけで、設定内容に基づいた全てのサービスを生成・起動します。

簡単に言えば、YAMLファイルに設定を記述することで、  
**複数のDockerコンテナをひとつのコマンドで定義・構築・起動することができるツール**  
です。

### Dockerfileとdocker-compose.ymlの違い

**▼Dockerfile**
【解説】  
Dockerfileとは
**ベースイメージから新しいDockerイメージをビルドするための手順を記述したファイル**
です。

Dockerを使用する際に、`docker container run`コマンド実行後に`docker exec -it [コンテナID] /bin/bash`コマンドでコンテナにログインし、必要なパッケージのインストールやファイルの作成などを手動で行うことがあります。  
これらの手順をDockerfileに記述しておくことで、イメージビルド時に自動的に実行され、カスタマイズされたイメージを作成できます。

【Dockerfileを用いたDockerイメージの作成の方法】
Dockerfileの配置されたディレクトリで以下のコマンドを実行します：

```bash
docker build -t [イメージ名] .
```

【メリット】
手動での複雑な手順が、Dockerfileを使うことで再現性の高い方法で自動化できます。

**▼docker-compose.yml**  
【解説】  
 Docker Composeは：

- **複数のコンテナで構成されるアプリケーションをDockerイメージのビルドや各コンテナの起動・停止などをより簡単に行えるようにするツール**です。
- docker-compose.ymlファイルに、複数コンテナの定義、ネットワーク設定、ボリューム設定などを記述します。
- 各サービス（コンテナ）の依存関係も管理できます。

【Dockerfileを用いたDockerイメージの作成の方法】
docker-compose.yml の配置されたディレクトリで以下のコマンドを実行します：

```bash
docker compose up -d
```

`注意: Docker Compose V2からは docker compose（ハイフンなし）が推奨されています。`

docker-compose.ymlに記述された内容に基づいて以下の処理が実行されます：

1. 必要なDockerイメージの作成（または取得）
2. ネットワークの作成
3. ボリュームの作成
4. コンテナの起動と設定（環境変数、ポート、ボリュームマウントなど）

【メリット】
複数のコンテナを個別に管理する手間が省け、アプリケーション全体の構成を一元管理できます。

## 🔧 docker-compose.ymlの基本構成

典型的なdocker-compose.ymlファイルは以下のような構造になっています：

:::details docker-compose.yml

```yml
version: "3"

services:
  db:
    image: postgres:13
    volumes:
      - postgres_data:/var/lib/postgresql/data
    environment:
      POSTGRES_PASSWORD: password
      POSTGRES_USER: postgres
      POSTGRES_DB: myapp_development
    ports:
      - "5432:5432"

  web:
    build: .
    command: bash -c "rm -f tmp/pids/server.pid && bundle exec rails s -p 3000 -b '0.0.0.0'"
    volumes:
      - .:/app
      - bundle_cache:/usr/local/bundle
    ports:
      - "3000:3000"
    depends_on:
      - db
    environment:
      DATABASE_URL: postgres://postgres:password@db:5432/myapp_development

volumes:
  postgres_data:
  bundle_cache:
```

:::

### 主要な構成要素

- **version**: 使用するDocker Composeのファイル形式のバージョン
- **services**: アプリケーションを構成する各サービス（コンテナ）の定義
- **volumes**: データを永続化するためのボリューム定義
- **networks**: コンテナ間の通信のためのネットワーク定義（上記例では省略）

### 重要な設定項目

- **build**: Dockerfileからイメージをビルドする設定

```yml
build:
  context: ./dir # Dockerfileのあるディレクトリ
  dockerfile: Dockerfile.dev # 使用するDockerfileの名前
```

- **volumes**: ホストとコンテナ間でファイルを共有する設定

```yml
volumes:
  - ./src:/app/src # ホストの./srcをコンテナの/app/srcにマウント
  - data_volume:/app/data # 名前付きボリュームをマウント
```

- **environment**: 環境変数の設定

```yml
environment:
  NODE_ENV: development
  API_KEY: your_api_key
```

または`.env`ファイルを使用：

```yml
env_file:
  - .env.development
```

- **depends_on**: サービス間の依存関係を定義

```yml
depends_on:
  - db
  - redis
```

- **networks**: コンテナを接続するネットワークの設定

```yml
networks:
  - frontend
  - backend
```

## 🔥 React × Rails アプリケーションの実践例

<https://github.com/kazukifukuyama14/rails-react>

以下は、React × Rails アプリケーションのためのDockerfile及びdocker-compose.ymlの例です。

### Dockerfile

:::details Dockerfile

```dockerfile
FROM ruby:3.1.2

# 必要なパッケージのインストール
RUN apt-get update -qq && apt-get install -y nodejs postgresql-client npm
RUN npm install --global yarn

WORKDIR /app

# Gemfileをコピーして依存関係をインストール
COPY Gemfile Gemfile.lock ./
RUN bundle install

# アプリケーションコードをコピー
COPY . .

# Webpackerのインストールと設定
RUN yarn install
RUN bundle exec rails webpacker:install

# サーバー起動時に実行されるスクリプト
COPY entrypoint.sh /usr/bin/
RUN chmod +x /usr/bin/entrypoint.sh
ENTRYPOINT ["entrypoint.sh"]

# Railsサーバーを起動
CMD ["rails", "server", "-b", "0.0.0.0"]
```

:::

### entrypoint.sh

:::details entrypoint.sh

```bash
#!/bin/bash
set -e

# サーバーのPIDファイルが存在する場合は削除
rm -f /app/tmp/pids/server.pid

# コマンドを実行
exec "$@"
```

:::

### docker-compose.yml

:::details docker-compose.yml

```yml
version: "3"

services:
  db:
    image: postgres:13
    volumes:
      - postgres_data:/var/lib/postgresql/data
    environment:
      POSTGRES_PASSWORD: password
      POSTGRES_USER: postgres
      POSTGRES_DB: myapp_development
    ports:
      - "5432:5432"

  web:
    build: .
    command: bash -c "rm -f tmp/pids/server.pid && bundle exec rails s -p 3000 -b '0.0.0.0'"
    volumes:
      - .:/app
      - node_modules:/app/node_modules
      - bundle_cache:/usr/local/bundle
    ports:
      - "3000:3000"
    depends_on:
      - db
    environment:
      DATABASE_URL: postgres://postgres:password@db:5432/myapp_development
      RAILS_ENV: development
      NODE_ENV: development

volumes:
  postgres_data:
  node_modules:
  bundle_cache:
```

:::

## 🛠 開発環境と本番環境の違い

開発環境と本番環境では、Docker Composeの設定が異なることが一般的です。

### 開発環境の特徴

- **ボリュームマウント**: ソースコードの変更をリアルタイムでコンテナに反映
- **デバッグツール**: デバッグに必要なツールを含める
- **ホットリロード**: コード変更時に自動的にアプリケーションを再読み込み

### 本番環境の特徴

- **最適化されたビルド**: 開発ツールを含まない軽量なイメージ
- **セキュリティ対策**: 必要最小限の権限とパッケージ
- **スケーラビリティ**: 複数のレプリカを実行可能な設定

### 環境別の設定ファイル

複数の環境に対応するために、以下のような構成が一般的です：

- `docker-compose.yml`: 基本設定
- `docker-compose.override.yml`: 開発環境用の追加設定（デフォルトで読み込まれる）
- `docker-compose.prod.yml`: 本番環境用の設定

本番環境で起動する場合：

```bash
docker compose -f docker-compose.yml -f docker-compose.prod.yml up -d
```

## 🔍 よくあるエラーとトラブルシューティング

### 1. データベース接続エラー

**症状**: Railsアプリケーションがデータベースに接続できない

**解決策**:

- **depends_on**が正しく設定されているか確認
- データベースの環境変数が正しいか確認
- データベースの環境変数が正しいか確認

```yml
depends_on:
  db:
    condition: service_healthy
```

### 2. ボリュームの権限問題

**症状**: ファイルの書き込み権限エラー

**解決策**:

- Dockerfileでアプリケーションディレクトリの所有者を適切に設定
- ボリュームマウントの権限を確認

### 3. Node.jsのバージョン互換性

**症状**: JavaScriptの依存関係のインストールに失敗

**解決策**:

- package.jsonで指定されているNode.jsのバージョンと一致するイメージを使用
- nvmを使用して適切なバージョンをインストール

## 📋 Docker Composeの便利なコマンド

### 基本コマンド

```bash
# コンテナのビルドと起動
docker compose up -d
```

```bash
# コンテナのビルド（キャッシュを使わない）
docker compose build --no-cache
```

```bash
# コンテナの停止
docker compose down
```

```bash
# コンテナ、ネットワーク、ボリュームの完全削除
docker compose down -v
```

```bash
# 特定のサービスのみ起動
docker compose up -d web
```

```bash
# コンテナ内でコマンドを実行
docker compose exec web rails console
```

```bash
# ログの確認
docker compose logs -f web
```

🚀 まとめ

Docker ComposeはReact × Railsアプリケーションの開発・デプロイを大幅に簡素化します。  
適切に設定することで：

- 開発環境のセットアップが簡単になる
- チーム内での環境の一貫性が保たれる
- 本番環境へのデプロイがスムーズになる
- マイクロサービスアーキテクチャの管理が容易になる

Docker Composeを使いこなすことで、アプリケーション開発のワークフローを効率化し、「動作環境の違い」による問題を解消できます。

---

## **参考リソース**

- [Docker Compose公式ドキュメント](https://docs.docker.com/compose/)
- [Rails on Docker公式ガイド](https://guides.rubyonrails.org/development_dependencies_install.html#docker)
- [GitHubリポジトリ](https://github.com/kazukifukuyama14/rails-react)
