---
title: "【実録】Auroraクラスタの料金が急増 → EventBridgeで夜間自動停止してコスト削減した話"
emoji: "🐷"
type: "tech" # tech: 技術記事 / idea: アイデア
topics: [AWS, RDS, EventBridge]
published: true
published_at: 2025-07-11 09:00
---

## 初めに

業務で使用している客先の環境から`Billing and Cost Management` を参照したところ、RDSの料金がかなり跳ね上がってしまっていました。  
そこで、使用しない時間帯でRDSの停止と起動の設定をしようと思います。

## やることリスト

- `EventBridge` から、RDS停止と起動のルールを新規作成
- `RDS` 停止起動用のIAMロールとポリシーを作成

![rdsevent](https://storage.googleapis.com/zenn-user-upload/d509f4c68dea-20250707.jpeg =250x)

## IAMロールとポリシーを作成

Classmethodさんが素晴らしい記事を公開されておりましたので、こちらを参考にして作成しましたので手順は割愛させていただきます。  
https://dev.classmethod.jp/articles/amazon-eventbridge-scheduler-rds-stop/#toc-5

IAMポリシーについては、作成当初下記のように作成していました。

```json:IAMポリシー
{
    "Version": "2012-10-17",
    "Statement": [
        {
            "Sid": "VisualEditor0",
            "Effect": "Allow",
            "Action": [
                "rds:StartDBCluster",
                "rds:StopDBCluster"
            ],
            "Resource": "arn:aws:rds:ap-northeast-1:アカウント番号:cluster:RDSクラスター"
        }
    ]
}
```

調べてみましたところ、どうやらこれだけでは不足しているみたいでした。

https://nhn-techorus.zendesk.com/hc/ja/articles/37624529021977-EventBridge-%E3%81%A7-Aurora-DB-%E3%82%A4%E3%83%B3%E3%82%B9%E3%82%BF%E3%83%B3%E3%82%B9%E3%82%92%E5%81%9C%E6%AD%A2%E3%81%97%E3%81%9F%E3%81%84%E3%81%8C-%E3%82%A8%E3%83%A9%E3%83%BC%E3%81%AB%E3%81%AA%E3%82%8A%E5%81%9C%E6%AD%A2%E3%81%A7%E3%81%8D%E3%81%BE%E3%81%9B%E3%82%93

EventBridge で Aurora DB インスタンスを停止や起動を実行するには、  
`rds:DescribeDBClusters` ・`rds:StopDBCluster` ・`rds:StartDBCluster`  
の3セットが必要みたいです。

`DescribeDBClusters` は、**対象のクラスター情報を取得する**ために必要です。  
これがないと、EventBridgeが対象のクラスターを特定できず、実行時にエラーになります。

それぞれの役割についてはAWS公式ドキュメントを参照ください。

https://docs.aws.amazon.com/ja_jp/service-authorization/latest/reference/list_amazonrds.html

また、IAMポリシーに **Systems Manager（SSM）関連の権限が不足**していたため、Automationドキュメントの実行に失敗する可能性が高いため権限を与える必要があります。  
AWS Systems Manager Automation 実行に必要なIAM権限の詳細はこちら：  
https://docs.aws.amazon.com/ja_jp/systems-manager/latest/userguide/security-iam.html

最終的に作成したIAMポリシーは以下のようになりました。

```json:IAMポリシー
{
    "Version": "2012-10-17",
    "Statement": [
        {
            "Sid": "VisualEditor0",
            "Effect": "Allow",
            "Action": [
                "rds:StartDBCluster",
                "rds:StopDBCluster",
                "rds:DescribeDBClusters"
            ],
            "Resource": "arn:aws:rds:ap-northeast-1:アカウント番号:cluster:RDSクラスター"
        },
        {
            "Sid": "VisualEditor1",
            "Effect": "Allow",
            "Action": [
                "ssm:*"
            ],
            "Resource": "*"
        }
    ]
}
```

> ※ ssm:"\*" は広範囲な権限を許可するため、必要なアクションに絞ることが推奨されます。  
> 本件は検証環境のため、Resourceは"\*"で指定しています。

推奨されるSSM権限（最小構成）は、以下が望ましいとされています。

```json:IAMポリシー
{
  "Effect": "Allow",
  "Action": [
    "ssm:StartAutomationExecution",
    "ssm:GetAutomationExecution",
    "ssm:DescribeAutomationExecutions",
    "ssm:GetDocument",
    "ssm:DescribeDocument"
  ],
  "Resource": "*"
}
```

| アクション名                     | 役割・説明                                                                                           |
| -------------------------------- | ---------------------------------------------------------------------------------------------------- |
| ssm:StartAutomationExecution     | Automationドキュメントを実行するための権限。EventBridgeからAutomationを起動する際に必須。            |
| ssm:GetAutomationExecution       | 実行されたAutomationの詳細情報（ステータスや出力など）を取得するための権限。                         |
| ssm:DescribeAutomationExecutions | 過去に実行されたAutomationの一覧を取得するための権限。監視やトラブルシュートに使用。                 |
| ssm:GetDocument                  | Automationドキュメントの内容を取得するための権限。ドキュメントのパラメータや構成を確認する際に必要。 |
| ssm:DescribeDocument             | Automationドキュメントのメタ情報（名前、タイプ、バージョンなど）を取得するための権限。               |

## EventBridgeルール作成

(2025年7月時点の画面構成です)

1. `Amazon EventBridge` > `ルール` へ遷移
2. ルールの画面から `ルールを作成` を押下

- ルールの詳細から、名前を定義(説明 - オプションは任意)
- イベントバスはdefault
- ルールタイプはスケジュールを選択して「続行してルールを作成する」を押下

3. スケジュールパターンから「特定の時刻～」を選択した状態でcron式で停止(または起動)させたい日時を設定
   ※cron式の詳細は下記を参照  
   https://qiita.com/koheki/items/ab4e86e448cee259aba3

4. ターゲットを選択の項目で、以下のように選択する(変更が必要な箇所のみ記載)

- ターゲットタイプ：AWS のサービス
- ターゲットを選択：System Manager オートメーション
- ドキュメント：AWS-StartStopAuroraCluster
- ClusterName：停止・起動対象のRDSクラスター名
- Action - オプション：Start or Stop
- 実行ロール：既存のロールを使用
- ロール名：前段で作成したロールを指定

5. タグの設定は任意で設定する
6. 最後に全体を確認して問題無ければページ下部の作成を押下

## 停止起動確認

客先での出来事なのでスクショなどを公開することはできませんが、確認しましたところ夜間停止・朝方起動されていることを確認できました。

## 得ることができたこと

- イベント設定で自動停止・起動の設定手順が身についた
- IAMポリシーの設定に関する理解が深まった

---

## 翌日の確認

後日メトリクスでルールが適用されたか確認したところ、**Auroraの停止すら実行されていませんでした。**

### EventBridgeルールが機能しなかった背景と原因

当初は、AWS EventBridge のルールを使って Aurora クラスターの起動・停止を自動化していましたが、**期待通りに停止処理が実行されない問題**が発生しました。

### 問題の内容

- 平日 23:00 に Aurora を停止するルールを設定していたが、**実際には停止されていなかった**
- CloudWatch メトリクスや Systems Manager Automation の実行履歴を確認しても、**該当時間に処理が実行されていない**

### 原因の特定

1. **EventBridgeルールのスケジュールが UTC ベースで動作していた**
   - ルール作成時にローカルタイム（JST）で設定したつもりだったが、内部的には UTC で解釈されていた
   - その結果、意図した時間にトリガーされていなかった可能性が高い

2. **AutomationAssumeRole の未指定**
   - EventBridgeルールのターゲット設定で、Systems Manager Automation に必要な IAM ロール（AutomationAssumeRole）が未指定だった
   - これにより、Automation ドキュメントの実行が失敗していた可能性がある

3. **EventBridgeルールの実行履歴が確認しづらい**
   - CloudWatch Logs に出力されていない場合、トラブルシュートが困難

### 対応方針

これらの課題を踏まえ、より柔軟でタイムゾーン対応が可能な **EventBridge Scheduler** を使って、Aurora の起動・停止を再構築することにしました。

## 旧構成（EventBridgeルール）

- **起動**：平日 08:00 JST
- **停止**：平日 23:00 JST
- **ターゲット**：Systems Manager Automation（`AWS-StartStopAuroraCluster`）
- **課題**：
  - UTCベースでのCron式管理が煩雑
  - タイムゾーン指定不可
  - 再試行やDLQの設定が柔軟でない

そこで、2022年にリリースされた **EventBridge Scheduler** を活用し、Aurora の起動・停止をより安定的に制御する構成に移行しました。

---

## 新構成（EventBridge Scheduler）

### スケジュール設定（例：Aurora起動）

- **Cron式**：`0 8 * * MON-FRI`
- **タイムゾーン**：`Asia/Tokyo`
- **ターゲットAPI**：`StartAutomationExecution`
- **ターゲットJSON**：

```json:ターゲットJSON
{
  "DocumentName": "AWS-StartStopAuroraCluster",
  "Parameters": {
    "ClusterName": ["Auroraクラスター名"],
    "Action": ["Start"],  //
    "AutomationAssumeRole": ["arn:aws:iam::アカウント番号:role/IAMロール名"]
  }
}
```

### スケジュール設定（例：Aurora停止）

- **Cron式**：`0 23 * * MON-FRI`
- **タイムゾーン**：`Asia/Tokyo`
- **ターゲットAPI**：`StartAutomationExecution`
- **ターゲットJSON**：

```json:ターゲットJSON
{
  "DocumentName": "AWS-StartStopAuroraCluster",
  "Parameters": {
    "ClusterName": ["Auroraクラスター名"],
    "Action": ["Stop"],  //
    "AutomationAssumeRole": ["arn:aws:iam::アカウント番号:role/IAMロール名"]
  }
}
```

### IAMロールのポリシー

```json:IAMロールポリシー
{
  "Version": "2012-10-17",
  "Statement": [
    {
      "Sid": "AllowRDSControl",
      "Effect": "Allow",
      "Action": [
        "rds:StartDBCluster",
        "rds:StopDBCluster",
        "rds:DescribeDBClusters"
      ],
      "Resource": "arn:aws:rds:ap-northeast-1:アカウント番号:cluster:Auroraクラスター名"
    },
    {
      "Sid": "AllowSSMAutomation",
      "Effect": "Allow",
      "Action": [
        "ssm:StartAutomationExecution"
      ],
      "Resource": "*"
    }
  ]
}
```

### 信頼されたエンティティ（トラストポリシー）

```json:信頼されたエンティティ
{
  "Version": "2012-10-17",
  "Statement": [
    {
      "Effect": "Allow",
      "Principal": {
        "Service": "scheduler.amazonaws.com"
      },
      "Action": "sts:AssumeRole"
    }
  ]
}
```

### 再試行ポリシーとDLQ設定

- 再試行回数：185回(Max)
- 最大経過時間：1日（hour(s): 24, minute(s): 0）
- DLQ：未設定（必要に応じて設定可能）

### 移行時の注意点

- ターゲットAPIは必ず StartAutomationExecution を選択すること！
  - StopAutomationExecution を選ぶと AutomationExecutionId が必要になりエラーになる
- EventBridgeルールはSchedulerの動作確認が完了するまで「無効化」して残しておくのが安全
- CloudWatch Logs や SSM Automation の実行履歴で動作確認を行う

### 最終的な構成のメリット

- JSTベースでのスケジュール管理が可能
- 柔軟な再試行・DLQ設定
- Automationの実行ログが明確
- 将来的なスケジュール管理の一元化にも対応しやすい

---

## 翌日の再確認

スケジュールで組み直してAuroraのメトリクスを確認したところ、昨晩23:00で停止しており、8:00に起動していることを確認しました。

## 反省点

- EventBridgeのルールとスケジュールの違いやメリット・デメリットを比較せず対応してしまったため、対応に手戻りが生じてしまった
- ことを起こす際は、まずは類似サービスなどを比較してしっかり選定することから始めていくようにする

## まとめ

EventBridge Scheduler を使うことで、Aurora の起動・停止をより安定的かつ柔軟に制御できるようになりました。  
既存のEventBridgeルールからの移行もスムーズに行えるため、同様の課題を抱えている方にはぜひおすすめしたい構成となっております。
